<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <link rel="website icon" type="png" href="neu-logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css">
    <link rel="stylesheet" href="fontawesome-free-6.7.1-web/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Helvetica">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="main.css">
    
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </script>

    
</head>
<style>
    .modal-content {
      border-radius: 1rem;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.2);
    }


    a {
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .password-mismatch {
      color: red;
      font-size: 0.875rem;
      display: none;
      margin-top: 0.25rem;
    }

    .password-match {
      color: green;
      font-size: 0.875rem;
      display: none;
      margin-top: 0.25rem;
    }

    /* Custom Alert Styles */
    .custom-alert {
      position: fixed;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1050;
      min-width: 250px;
      max-width: 400px;
      border-radius: 8px;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.2);
      display: none;
    }

    .custom-alert.show {
      display: block;
    }

    .custom-alert .alert-icon {
      font-size: 1.5rem;
      margin-right: 12px;
    }

    .custom-alert .close-btn {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
    }

    #userRecordsTable tbody td:nth-child(5) .user-type,
    #accountRequestsTable tbody td:nth-child(5) .user-type {
        display: inline-block;
        padding: 4px 16px;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        color: #fff;
        text-transform: capitalize;
        text-align: center;
        min-width: 100px;
    }

    .user-type.student {
        background-color: #FF9500;
    }

    .user-type.alumni {
        background-color: #14a114;
    }

    .user-type.faculty {
        background-color: #0092CC;
    }

    .user-type.admin {
        background-color: #2c2c2c;
    }

    .table-wrapper thead {
    position: sticky;
    top: 0;
    z-index: 3;
    
}


.actions-dropdown {
    position: relative;
    display: inline-block;
    
}

.actions-menu {
    position: absolute;
    right: 0;
    background-color: white;
    min-width: 120px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    border-radius: 4px;
    padding: 8px;
    z-index: 2;
    display: none;
}

.actions-menu.show {
    display: block;
}

.action-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    cursor: pointer;
    color: #333;
    border-radius: 4px;
}

.action-item:hover {
    background-color: #f1f1f1;
}

.action-item i {
    margin-right: 0.5rem;
    width: 16px;
}

.actions-dropdown button {
    border: none;
    outline: none;
    background: none;
    padding: 0.25rem 0.5rem;
}

.actions-dropdown button:focus {
    border: none;
    outline: none;
    box-shadow: none;
}

.table-wrapper #fileRecordsTable td:nth-child(7),
.table-wrapper #userRecordsTable td:nth-child(7) {
    overflow: visible !important;
}

.form-label::after {
        content: " *";
        color: red;
    }

.nav-tabs .nav-link {
    font-size: 1.2rem;
    font-weight: 500;
    padding: 0.75rem 1.25rem;
    color: #6c757d; /* Gray color for inactive tabs */
}

.nav-tabs .nav-link.active {
    color: #005580; /* Blue color for active tab */
    border-bottom: 3px solid #005580; /* Add bottom border to active tab */
}

.nav-tabs {
    font-size: 1.2rem;
    margin-right: 0.5rem;
}

    .delete-selected {
        display: none;
        margin-right: 8px;
    }
    
    .delete-selected.show {
        display: inline-block;
    }
    
    .checkbox-column {
        width: 70px;
        text-align: center;
    }
    
    .select-checkbox {
        width: 15px;
        height: 15px;
        cursor: pointer;
        
    }

    </style>


<body>
    <!-- Custom Alert -->
  <div id="customAlert" class="custom-alert alert" role="alert">
    <div class="d-flex align-items-center">
      <span class="alert-icon"></span>
      <span id="alertMessage"></span>
      <button type="button" class="close-btn ms-auto" aria-label="Close" onclick="hideAlert()">&times;</button>
    </div>
  </div>


  <div class="modal fade" id="fileUploadModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="fileUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileUploadModalLabel">Upload Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <div class="file-box" onclick="document.getElementById('pdfFile').click();">
                <div class="file-upload-wrapper">
                    <div class="upload-elements"> <!-- Wrap elements to hide -->
                        <i class="fas fa-cloud-upload-alt upload"></i> 
                        <h1>Drag and Drop File</h1>
                        <h1>or</h1>
                        <button type="button" class="btn btn-secondary">Browse</button>
                    </div>
                    <input type="file" id="pdfFile" accept=".pdf" multiple required>
                    <span class="file-name"></span>
                </div>
            </div>
            <div class="upload-status mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-remove" onclick="removeFile()">
                     Remove
                </button>
                <button type="button" class="btn btn-primary btn-upload">
                     Upload
                </button>
            </div>
            </div>
        </div>
              
            </div>
            
    
  <!-- Add this modal HTML -->
  <div class="modal fade" id="editFileModal" tabindex="-1" aria-labelledby="editFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editFileModalLabel">Edit File Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editFileForm">
                    <div class="mb-3">
                        <label for="editFileName" class="form-label">File Name</label>
                        <input type="text" class="form-control" id="editFileName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAuthor" class="form-label">Author</label>
                        <input type="text" class="form-control" id="editAuthor">
                    </div>
                    <div class="mb-3">
                        <label for="editYear" class="form-label">Year</label>
                        <input type="number" class="form-control" id="editYear" min="1900" max="2099">
                    </div>
                    <div class="mb-3">
                        <label for="editCourse" class="form-label">Course</label>
                        <select class="form-select" id="editCourse">
                            <option value="Computer Science">Computer Science</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Information Systems">Information Systems</option>
                            <option value="Library Information Science">Library Information Science</option>
                        </select>
                    </div>
                    <input type="hidden" id="originalFileName">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFileDetails">Save Changes</button>
            </div>
        </div>
    </div>
</div>
  <!-- Admin Create User -->
  <div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="signupModalLabel">Create User
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="signupForm">
            <div class="mb-3">
              <label for="userType" class="form-label">User Type</label>
              <select class="form-select" id="userType" required>
                <option value="" selected disabled>Select User Type</option>
                <option value="student" id="studentUser">Student</option>
                <option value="alumni" id="alumniUser">Alumni</option>
                <option value="faculty" id="facultyUser">Faculty</option>
                <option value="admin" id="adminUser">Admin</option>
              </select>
            </div>
            <div class="mb-3">
              <div class="row">
                <div class="col-md-5">
                  <label for="lastName" class="form-label">Last Name</label>
                  <input type="text" class="form-control" id="lastName" placeholder="Dela Cruz" required>
                </div>
                <div class="col-md-5">
                  <label for="firstName" class="form-label">First Name</label>
                  <input type="text" class="form-control" id="firstName" placeholder="Juan" required>
                </div>
                <div class="col-md-2">
                  <label for="middleInitial" class="form-label">MI</label>
                  <input type="text" class="form-control" id="middleInitial" placeholder="P" maxlength="">
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="signupEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email" required>
              <div id="emailExists" class="password-mismatch">Email is already registered.</div>
            </div>
            <div class="mb-3" id="idField">
              <label for="signupID" class="form-label">ID</label>
              <input type="text" class="form-control" id="signupID" placeholder="Enter your ID" required>
            </div>
            <div class="mb-3 row">
              <div class="col-md-6">
                <label for="signupPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="signupPassword" placeholder="at least 6 characters" required>
              </div>
              <div class="col-md-6">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirmPassword" placeholder="" required>
                <div id="passwordMismatch" class="password-mismatch">Passwords do not match.</div>
                <div id="passwordMatch" class="password-match">Passwords match!</div>
              </div>
            </div>
            <div class="mb-3" id="certificateField">
              <label for="certificateUpload" class="form-label">Upload Certificate of Matriculation (Latest)</label>
              <input type="file" class="form-control" id="certificateUpload" accept="image/*" required>
            </div>
           
            <button type="submit" class="btn btn-primary w-100" id="submitSignupForm">Submit</button>
          </form>
        </div>
      </div>
    </div>
  </div>
    
  <header>
    <h1>Admin Dashboard</h1>
    <div class="nav-links">
        <a href="index.html">NEUA</a>
        <div class="separator"></div>
        
        <button type="button" onclick="logout()">Logout</button>
    </div>
  </header>
    
    <div class="container-fluid">
        

        
    
       
        <div class="dashboard-stats">

            <div class="stat">
                <i class="fa-solid fa-file"></i>
                <div class="stat-info">
                    <h3 id="fileCount">0</h3> <!-- h3 id NEW!-->
                    <p>Files</p>
                </div>
            </div>
        
        
            <div class="stat">
                <i class="fa-solid fa-users"></i>
                <div class="stat-info">
                    <h3 id="userCount">0</h3> <!-- h3 id NEW!-->
                    <p>Users</p>
                </div>
            </div>

            <div class="stat"> <!-- account request stat NEW!-->
                <i class="fa-solid fa-user-plus"></i>
                <div class="stat-info">
                    <h3 id="accountRequestsCount">0</h3> <!-- h3 id NEW!-->
                    <p>Account Requests</p>
                </div>
            </div>


        
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="true">
                    File Records
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="false">
                    User Records
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests" type="button" role="tab" aria-controls="requests" aria-selected="false">
                    Account Requests
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabsContent">
            <!-- File Records Tab -->
            <div class="tab-pane fade show active" id="files" role="tabpanel" aria-labelledby="files-tab">
                <div class="search-container">
                    <h2>File Records</h2>
                    <div class="search-controls">
                        <button type="button" class="btn btn-danger btn-delete-selected delete-selected" onclick="deleteSelectedFiles()">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <button type="button" class="btn btn-refresh btn-outline-secondary me-2" onclick="refreshFileRecords()">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </button>
                        <button type="button" class="btn btn-export btn-outline-secondary" onclick="exportFileRecords()">
                            <i class="fa-solid fa-share-from-square"></i>
                        </button>
                        <input type="text" id="fileSearch" placeholder="Search file records..." oninput="filterFileRecords()">
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table id="fileRecordsTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">
                                    <input type="checkbox" class="select-checkbox" id="selectAll" onclick="toggleSelectAll()">
                                </th>
                                <th onclick="sortTable('fileRecordsTable', 1)">Title <span id="fileRecordsTableHeader1"></span></th>
                                <th onclick="sortTable('fileRecordsTable', 2)">Author <span id="fileRecordsTableHeader2"></span></th>
                                <th onclick="sortTable('fileRecordsTable', 3)">Year <span id="fileRecordsTableHeader3"></span></th>
                                <th onclick="sortTable('fileRecordsTable', 4)">Course <span id="fileRecordsTableHeader4"></span></th>
                                <th onclick="sortTable('fileRecordsTable', 5)">Date Modified <span id="fileRecordsTableHeader5"></span></th>
                                <th class="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>

                <div class="text-end mt-3">
                    <button type="button" class="btn btn-outline-secondary" id="FileUpload" data-bs-toggle="modal" data-bs-target="#fileUploadModal">
                        <i class="fas fa-plus"></i> Add File
                    </button>
                </div>

                <div class="pagination-container">
                    <div class="rows-per-page">
                        <span>Showing</span>
                        <select id="rowsPerPage" onchange="changeRowsPerPage()">
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span>rows per page</span>
                    </div>
                    <div id="fileRecordsTablePagination" class="pagination"></div>
                </div>
            </div>

            <!-- User Records Tab -->
            <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
                <div class="search-container">
                    <h2>User Records</h2>
                    <div class="search-controls">
                        <button type="button" class="btn btn-refresh btn-outline-secondary me-2" onclick="refreshUserRecords()">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </button>
                        <button type="button" class="btn btn-export btn-outline-secondary" onclick="exportUserRecords()">
                            <i class="fa-solid fa-share-from-square"></i>
                        </button>
                        <input type="text" id="userSearch" placeholder="Search user records..." oninput="filterUserRecords()">
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="userRecordsTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('userRecordsTable', 0)"># <span id="userRecordsTableHeader0"></span></th>
                                <th onclick="sortTable('userRecordsTable', 1)">Name <span id="userRecordsTableHeader1"></span></th>
                                <th onclick="sortTable('userRecordsTable', 2)">Email <span id="userRecordsTableHeader2"></span></th>
                                <th onclick="sortTable('userRecordsTable', 3)">ID <span id="userRecordsTableHeader3"></span></th>
                                <th onclick="sortTable('userRecordsTable', 4)">User Type <span id="userRecordsTableHeader4"></span></th>
                                <th onclick="sortTable('userRecordsTable', 5)">Requests <span id="userRecordsTableHeader5"></span></th>
                                <th class="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>

                <div class="text-end mt-3">
                    <button type="button" class="btn btn-outline-secondary" id="CreateUser" data-bs-toggle="modal" data-bs-target="#signupModal">
                        <i class="fas fa-plus"></i> Create User
                    </button>
                </div>

                <div class="pagination-container">
                    <div class="rows-per-page">
                        <span>Showing</span>
                        <select id="rowsPerPage" onchange="changeRowsPerPage()">
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span>rows per page</span>
                    </div>
                    <div id="userRecordsTablePagination" class="pagination"></div>
                </div>
            </div>

            <!-- Account Requests Tab -->
            <div class="tab-pane fade" id="requests" role="tabpanel" aria-labelledby="requests-tab">
                <div class="search-container">
                    <h2>Account Requests</h2>
                    <div class="search-controls">
                        <button type="button" class="btn btn-refresh btn-outline-secondary me-2" onclick="refreshAccountRequestsRecords()">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </button>
                        <button type="button" class="btn btn-export btn-outline-secondary" onclick="exportAccountRequestsRecords()">
                            <i class="fa-solid fa-share-from-square"></i>
                        </button>
                        <input type="text" id="accountRequestSearch" placeholder="Search account requests..." oninput="filterAccountRequests()">
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="accountRequestsTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('accountRequestsTable', 0)"># <span id="accountRequestsTableHeader0"></span></th>
                                <th onclick="sortTable('accountRequestsTable', 1)">Name <span id="accountRequestsTableHeader1"></span></th>
                                <th onclick="sortTable('accountRequestsTable', 2)">Email <span id="accountRequestsTableHeader2"></span></th>
                                <th onclick="sortTable('accountRequestsTable', 3)">ID <span id="accountRequestsTableHeader3"></span></th>
                                <th onclick="sortTable('accountRequestsTable', 4)">User Type <span id="accountRequestsTableHeader4"></span></th>
                                <th>COM</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination-container">
                    <div class="rows-per-page">
                        <span>Showing</span>
                        <select id="rowsPerPage" onchange="changeRowsPerPage()">
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span>rows per page</span>
                    </div>
                    <div id="accountRequestsTablePagination" class="pagination"></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="loader">
        <div class="loader-backdrop"></div>
        <div class="loader-container">
            <div class="loader-spinner"></div>
        </div>
    </div>
    <footer>
        <p class="copyright">2024 Â© NEUA All rights reserved.</p>
    </footer>
<div class="to-top-btn">
    <button onclick="topFunction()" id="myBtn" title="Go to top"><i class="fas fa-angle-up"></i></button>
</div>
    <script>
        
        function clearSessionOnExit() {
            sessionStorage.removeItem('adminAuthenticated');
        }
        
        const dropArea = document.querySelector('.file-box');
        const fileInput = document.getElementById("pdfFile");
        const fileNameDisplay = document.querySelector(".file-name");
        const uploadElements = document.querySelector('.upload-elements');
        const uploadStatus = document.querySelector('.upload-status');
        let selectedFiles = [];
        
        fileInput.addEventListener("change", function() {
            const files = Array.from(this.files);
        
            if (files.length + selectedFiles.length > 20) {
                alert("You can only upload up to 20 PDF files.");
                return;
            }
        
            selectedFiles = selectedFiles.concat(files);
            const fileNames = selectedFiles.map(file => file.name).join(', ');
            fileNameDisplay.textContent = fileNames;
            uploadElements.style.display = 'none';
        });
        
        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('dragover', handleDragOver, false);
        dropArea.addEventListener('dragleave', handleDragLeave, false);
        
        function handleDragOver(event) {
            event.preventDefault();
            dropArea.classList.add('dragging');
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            dropArea.classList.remove('dragging');
        }
        
        function handleDrop(event) {
            event.preventDefault();
            dropArea.classList.remove('dragging');
        
            const files = Array.from(event.dataTransfer.files);
        
            if (files.length + selectedFiles.length > 20) {
                alert("You can only upload up to 20 PDF files.");
                return;
            }
        
            selectedFiles = selectedFiles.concat(files);
            const fileNames = selectedFiles.map(file => file.name).join(', ');
            fileNameDisplay.textContent = fileNames;
            uploadElements.style.display = 'none';
        }
        
        document.querySelector(".btn-upload").addEventListener("click", function() {
            if (selectedFiles.length === 0) {
                alert("Please Select PDF Files First.");
                return;
            }
        
            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('pdfFiles[]', file);
            });
        
            uploadStatus.textContent = 'Uploading...';
        
            fetch('adminhomepage.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadStatus.textContent = 'Upload complete!';
                } else {
                    uploadStatus.textContent = 'Upload failed: ' + data.message;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                uploadStatus.textContent = 'Upload failed. Please try again.';
            });
        
            // Clear the file input and display
            fileInput.value = ''; // Clear the file input
            fileNameDisplay.textContent = ''; // Clear the displayed file names
            selectedFiles = []; // Reset the selected files
        });
        
        // Handle Remove button click
        document.querySelector(".btn-remove").addEventListener("click", removeFile);
        
        function removeFile() {
            // Reset the file input and related variables
            selectedFiles = [];
            fileInput.value = ''; // Clear the file input element
            fileNameDisplay.textContent = ''; // Clear the displayed file names
            uploadStatus.style.color = '#002635';  // Reset color after for new upload
            
            // Show upload elements again for the user to upload new files
            uploadElements.style.display = 'block'; // Re-display the upload instructions
        
            // Clear any upload status messages
            uploadStatus.textContent = '';
        }
        
        // Pagination helper functions
        function paginate(records, currentPage, rowsPerPage) {
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            return records.slice(startIndex, endIndex);
        }
        
        function createPaginationButtons(totalRecords, rowsPerPage, currentPage, paginationContainerId) {
            const paginationContainer = document.getElementById(paginationContainerId);
            const totalPages = Math.ceil(totalRecords.length / rowsPerPage);
            paginationContainer.innerHTML = ''; // Clear existing pagination
        
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo;';
            prevButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    changePage(currentPage - 1, paginationContainerId);
                }
            });
            paginationContainer.appendChild(prevButton);
        
            // Page number buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageButton.addEventListener('click', () => changePage(i, paginationContainerId));
                paginationContainer.appendChild(pageButton);
            }
        
            // Next button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '&raquo;';
            nextButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    changePage(currentPage + 1, paginationContainerId);
                }
            });
            paginationContainer.appendChild(nextButton);
        }
        
        // Global variables to track pagination state
        let currentFileRecordsPage = 1;
        let currentUserRecordsPage = 1;
        let fileRecordsRowsPerPage = 20;
        let userRecordsRowsPerPage = 20;
        
        // Global variable to store file records
        let globalFileRecords = [];
        
        // Function to fetch and display file records
        function fetchFileRecords() {
            fetch('adminhomepage.php?action=getFiles')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        globalFileRecords = data.files; // Store records globally
                        updateFileRecordsTable(data.files);
                    } else {
                        console.error('Failed to fetch file records:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching file records:', error);
                });
        }
        
        // Enhanced file records pagination function
        function updateFileRecordsTable(files) {
            const fileRecordsTable = document.getElementById('fileRecordsTable').getElementsByTagName('tbody')[0];
            fileRecordsTable.innerHTML = ''; // Clear existing rows
        
            // Paginate the files
            const paginatedFiles = paginate(files, currentFileRecordsPage, fileRecordsRowsPerPage);
        
            paginatedFiles.forEach((file, index) => {
                const row = fileRecordsTable.insertRow();
                row.insertCell(0).textContent = ((currentFileRecordsPage - 1) * fileRecordsRowsPerPage) + index + 1;
                
                // Simple non-clickable title cell
                const titleCell = row.insertCell(1);
                titleCell.textContent = file.name;
                
                row.insertCell(2).textContent = file.author || 'N/A';
                row.insertCell(3).textContent = file.year || 'N/A';
                row.insertCell(4).textContent = 'Course';
                row.insertCell(5).textContent = file.last_modified;
                
                // Create actions cell with view, edit, and delete icons
                const actionsCell = row.insertCell(6);
                actionsCell.classList.add('actions');
                
                // View icon
                const viewIcon = document.createElement('i');
                viewIcon.classList.add('fas', 'fa-eye');
                viewIcon.title = 'View File';
                viewIcon.onclick = () => window.open(`pdfs/${file.name}`, '_blank');
                
                // Edit icon
                const editIcon = document.createElement('i');
                editIcon.classList.add('fas', 'fa-edit');
                editIcon.title = 'Edit File Details';
                editIcon.onclick = () => editFileDetails(file.name);
                
                // Delete icon
                const deleteIcon = document.createElement('i');
                deleteIcon.classList.add('fas', 'fa-trash');
                deleteIcon.title = 'Delete File';
                deleteIcon.onclick = () => deleteFile(file.name);
                
                // Append icons to actions cell
                actionsCell.appendChild(viewIcon);
                actionsCell.appendChild(editIcon);
                actionsCell.appendChild(deleteIcon);
            });
        }
        
        // Function to filter file records
        function filterFileRecords() {
            const searchInput = document.getElementById('fileSearch').value.toLowerCase();
            
            // If search is empty, show all records
            if (searchInput.trim() === '') {
                updateFileRecordsTable(globalFileRecords);
                return;
            }
        
            // Filter records based on search input
            const filteredRecords = globalFileRecords.filter(file => 
                file.name.toLowerCase().includes(searchInput)
            );
        
            // Reset to first page when filtering
            currentFileRecordsPage = 1;
            updateFileRecordsTable(filteredRecords);
        }
        
        // Function to delete a file
        function deleteFile(fileName) {
            if (confirm('Are you sure you want to delete ' + fileName + '?')) {
                fetch('adminhomepage.php?action=deleteFile&file=' + encodeURIComponent(fileName))
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('File deleted successfully!');
                            fetchFileRecords(); // Refresh the file records
                        } else {
                            alert('Failed to delete file: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting file:', error);
                    });
            }
        }
        
        // Modify changeRowsPerPage to handle pagination
        function changeRowsPerPage() {
            const fileRowsSelect = document.getElementById('rowsPerPage');
            
            // For file records
            fileRecordsRowsPerPage = parseInt(fileRowsSelect.value);
            currentFileRecordsPage = 1; // Reset to first page
            updateFileRecordsTable(globalFileRecords);
        }
         
       
        
        // Fetch file records when the page loads
        document.addEventListener('DOMContentLoaded', fetchFileRecords);
        
        // Function to update file count in dashboard stats
        function updateFileCount() {
            fetch('adminhomepage.php?action=getFiles')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.files) {
                        // Update the files count in the dashboard stats
                        const fileCountElement = document.querySelector('.dashboard-stats .stat:first-child h3');
                        if (fileCountElement) {
                            fileCountElement.textContent = data.files.length;
                        }
                    } else {
                        console.error('Failed to fetch file count:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching file count:', error);
                });
        }
        
        // Update file count when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            updateFileCount();
        
            // Modify existing fetchFileRecords to call updateFileCount after file operations
            const originalFetchFileRecords = fetchFileRecords;
            fetchFileRecords = function() {
                originalFetchFileRecords();
                updateFileCount();
            };
        });
        function updateFileRecordsTable(files) {
            const fileRecordsTable = document.getElementById('fileRecordsTable').getElementsByTagName('tbody')[0];
            fileRecordsTable.innerHTML = ''; // Clear existing rows
      // Paginate the files
      const paginatedFiles = paginate(files, currentFileRecordsPage, fileRecordsRowsPerPage);

paginatedFiles.forEach((file, index) => {
    const row = fileRecordsTable.insertRow();
    row.insertCell(0).textContent = ((currentFileRecordsPage - 1) * fileRecordsRowsPerPage) + index + 1;
    
        
        // Simple non-clickable title cell
        const titleCell = row.insertCell(1);
        titleCell.textContent = file.name;
        
        row.insertCell(2).textContent = 'Author'; // Replace with actual author if available
        row.insertCell(3).textContent = 'Year'; // Replace with actual year if available
        row.insertCell(4).textContent = 'Course'; // Replace with actual course if available
        row.insertCell(5).textContent = file.last_modified;
        
        // Create actions cell with view, edit, and delete icons
        const actionsCell = row.insertCell(6);
        actionsCell.classList.add('actions');
        
        // View icon
        const viewIcon = document.createElement('i');
        viewIcon.classList.add('fas', 'fa-eye');
        viewIcon.title = 'View File';
        viewIcon.onclick = () => window.open(`pdfs/${file.name}`, '_blank');
        
        // Edit icon
        const editIcon = document.createElement('i');
        editIcon.classList.add('fas', 'fa-edit');
        editIcon.title = 'Edit File Details';
        editIcon.onclick = () => editFileDetails(file.name);
        
        // Delete icon
        const deleteIcon = document.createElement('i');
        deleteIcon.classList.add('fas', 'fa-trash');
        deleteIcon.title = 'Delete File';
        deleteIcon.onclick = () => deleteFile(file.name);
        
        // Append icons to actions cell
        actionsCell.appendChild(viewIcon);
        actionsCell.appendChild(editIcon);
        actionsCell.appendChild(deleteIcon);
    });
}


// Add placeholder functions if not already defined
function editFileDetails(fileName) {
    const file = globalFileRecords.find(f => f.name === fileName);
    
    // Get the modal
    const editFileModal = new bootstrap.Modal(document.getElementById('editFileModal'));
    
    // Set current values
    document.getElementById('originalFileName').value = fileName;
    document.getElementById('editFileName').value = fileName.replace('.pdf', '');
    document.getElementById('editAuthor').value = file.author || '';
    document.getElementById('editYear').value = file.year || '';
    document.getElementById('editCourse').value = file.course || 'Computer Science';

    // Show the modal
    editFileModal.show();

    // Handle save button click
    document.getElementById('saveFileDetails').onclick = function() {
        const newFileName = document.getElementById('editFileName').value.trim() + '.pdf';
        const newAuthor = document.getElementById('editAuthor').value.trim();
        const newYear = document.getElementById('editYear').value.trim();
        const newCourse = document.getElementById('editCourse').value;

        const formData = new FormData();
        formData.append('action', 'updateFile');
        formData.append('originalFileName', fileName);
        formData.append('newFileName', newFileName);
        formData.append('author', newAuthor);
        formData.append('year', newYear);
        formData.append('course', newCourse);

        fetch('adminhomepage.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the global records array
                const fileIndex = globalFileRecords.findIndex(f => f.name === fileName);
                if (fileIndex !== -1) {
                    globalFileRecords[fileIndex] = {
                        ...globalFileRecords[fileIndex],
                        name: newFileName,
                        author: newAuthor,
                        year: newYear,
                        course: newCourse,
                        last_modified: new Date().toISOString().split('T')[0]
                    };
                }
                
                // Update the table display
                updateFileRecordsTable(globalFileRecords);
                
                editFileModal.hide();
                showAlert('File details updated successfully!', 'success');
            } else {
                showAlert('Error updating file: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error updating file details', 'error');
        });
    };
}

// Update the updateFileRecordsTable function
function updateFileRecordsTable(files) {
    const fileRecordsTable = document.getElementById('fileRecordsTable').getElementsByTagName('tbody')[0];
    fileRecordsTable.innerHTML = ''; // Clear existing rows
    
    const paginatedFiles = paginate(files, currentFileRecordsPage, fileRecordsRowsPerPage);

    paginatedFiles.forEach((file, index) => {
        const row = fileRecordsTable.insertRow();
        row.insertCell(0).textContent = ((currentFileRecordsPage - 1) * fileRecordsRowsPerPage) + index + 1;
        
        // File name cell
        const titleCell = row.insertCell(1);
        titleCell.textContent = file.name;
        titleCell.style.cursor = 'pointer';
        titleCell.onclick = () => window.open(`pdfs/${file.name}`, '_blank');
        
        // Author, Year, Course cells with actual data
        row.insertCell(2).textContent = file.author || 'N/A';
        row.insertCell(3).textContent = file.year || 'N/A';
        row.insertCell(4).textContent = file.course || 'N/A';
        row.insertCell(5).textContent = file.last_modified;
        
        // Actions cell with dropdown
        const actionsCell = row.insertCell(6);
        actionsCell.className = 'actions';
        const dropdownHtml = `
            <div class="actions-dropdown">
                <button class="btn btn-sm" onclick="toggleActionsMenu(this)">
                    <i class="fas fa-ellipsis"></i>
                </button>
                <div class="actions-menu">
                    <div class="action-item" onclick="viewPdf('${file.name}')">
                        <i class="fas fa-eye"></i>View
                    </div>
                    <div class="action-item" onclick="editRow(this.closest('.actions-dropdown'))">
                        <i class="fas fa-edit"></i>Edit
                    </div>
                    <div class="action-item delete-action" onclick="deleteRow(this.closest('.actions-dropdown'))">
                        <i class="fas fa-trash"></i>Delete
                    </div>
                </div>
            </div>`;
        actionsCell.innerHTML = dropdownHtml;
    });
}

// Add these helper functions
function toggleActionsMenu(button) {
    const menu = button.nextElementSibling;
    // Close all other open menus
    document.querySelectorAll('.actions-menu.show').forEach(openMenu => {
        if (openMenu !== menu) openMenu.classList.remove('show');
    });
    menu.classList.toggle('show');
}

function viewPdf(fileName) {
    window.open(`pdfs/${fileName}`, '_blank');
}

function editRow(dropdown) {
    const row = dropdown.closest('tr');
    const fileName = row.cells[1].textContent;
    editFileDetails(fileName);
}

function deleteRow(dropdown) {
    const row = dropdown.closest('tr');
    const fileName = row.cells[1].textContent;
    deleteFile(fileName);
}

// Close dropdown menus when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.actions-dropdown')) {
        document.querySelectorAll('.actions-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

function showAlert(message, type) {
    const alertDiv = document.getElementById('customAlert');
    const alertMessage = document.getElementById('alertMessage');
    
    alertDiv.className = `custom-alert alert alert-${type} show`;
    alertMessage.textContent = message;
    
    setTimeout(() => {
        alertDiv.classList.remove('show');
    }, 3000);
}

function setupPagination(tableId, rows) {
    const pagination = document.getElementById(`${tableId}Pagination`);
    const rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
    const totalPages = Math.ceil(rows.length / rowsPerPage);
    let currentPage = 1;

    function showPage(page) {
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        rows.forEach((row, index) => {
            row.style.display = (index >= start && index < end) ? '' : 'none';
        });

        updatePaginationButtons(page);
    }

    function updatePaginationButtons(page) {
        pagination.innerHTML = '';
        
        // Previous button
        const prevButton = document.createElement('button');
        prevButton.innerHTML = '&laquo;';
        prevButton.disabled = page === 1;
        prevButton.addEventListener('click', () => showPage(page - 1));
        pagination.appendChild(prevButton);

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.classList.toggle('active', i === page);
            button.addEventListener('click', () => showPage(i));
            pagination.appendChild(button);
        }

        // Next button
        const nextButton = document.createElement('button');
        nextButton.innerHTML = '&raquo;';
        nextButton.disabled = page === totalPages;
        nextButton.addEventListener('click', () => showPage(page + 1));
        pagination.appendChild(nextButton);
    }

    showPage(1);
}

// Table sort handler
function sortTable(tableId, columnIndex) {
    const table = document.getElementById(tableId);
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const headerSpan = document.getElementById(`${tableId}Header${columnIndex}`);
    const isAsc = headerSpan.classList.contains('asc');

    // Clear all arrow classes
    document.querySelectorAll(`#${tableId} th span`).forEach(span => {
        span.classList.remove('asc', 'desc');
    });
    
    // Set new sort indicator
    headerSpan.classList.toggle('asc', !isAsc);
    headerSpan.classList.toggle('desc', isAsc);

    // Sort rows (keeping your existing sort logic)
    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent;
        let bValue = b.cells[columnIndex].textContent;

        // Handle numeric sorting for index column
        if (columnIndex === 0) {
            aValue = parseInt(aValue) || 0;
            bValue = parseInt(bValue) || 0;
            return isAsc ? aValue - bValue : bValue - aValue;
        }

        // String comparison for other columns
        return isAsc ? 
            aValue.localeCompare(bValue) : 
            bValue.localeCompare(aValue);
    });

    // Reinsert rows in new order
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

// Add email validation for admin create user        
document.getElementById("signupEmail").addEventListener("blur", function() {
    const email = this.value;
    if(email) {
        fetch('adminhomepage.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                action: 'checkEmail',
                email: email 
            })
        })
        .then(response => response.json())
        .then(data => {
            const emailExists = document.getElementById("emailExists");
            const submitButton = document.getElementById("submitSignupForm");
            
            if (data.exists) {
                emailExists.style.display = "block";
                submitButton.disabled = true;
            } else {
                emailExists.style.display = "none";
                submitButton.disabled = false;
            }
        });
    }
});

function updateAccountRequestsTable(users) {
    const tbody = document.querySelector('#accountRequestsTable tbody');
    tbody.innerHTML = ''; // Clear existing rows
    
    users.forEach((user, index) => {
        const row = tbody.insertRow();
        
        // Add index cell
        row.insertCell(0).textContent = index + 1;

        // Add name, email, ID, and user type cells with copy functionality
        const values = [user.name, user.email, user.user_id, user.user_type];
        values.forEach((value, cellIndex) => {
            const cell = row.insertCell();
            if (cellIndex === 3) { // User Type column
                const span = document.createElement('span');
                const capitalizedUserType = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                span.textContent = capitalizedUserType;
                span.classList.add('user-type', value.toLowerCase());
                cell.appendChild(span);
            } else {
                cell.textContent = value;
                // Add copy functionality only to name, email, and ID columns
                if (cellIndex >= 0 && cellIndex <= 2) {
                    cell.setAttribute('title', 'Click to copy');
                    cell.style.cursor = 'pointer';
                    cell.onclick = () => copyToClipboard(value);
                }
            }
        });

        // Add COM and Actions cells
        const comCell = row.insertCell();
        comCell.className = 'text-center';
        if (user.certificate_file) {
            comCell.innerHTML = `
                <button class="btn btn-sm btn-primary" onclick="viewCertificate('${user.certificate_file}')">
                    <i class="fas fa-eye"></i> View
                </button>`;
        } else {
            comCell.textContent = 'No file';
        }

        // Add actions cell
        const actionsCell = row.insertCell();
        actionsCell.className = 'actions';
        actionsCell.innerHTML = `
            <button class="btn btn-outline-success btn-sm action-box" onclick="approveUser('${user.requestId}')">
                <i class="fas fa-check"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm action-box" onclick="rejectUser('${user.requestId}')">
                <i class="fas fa-times"></i>
            </button>
        `;
    });

    document.getElementById('accountRequestsCount').textContent = users.length;
}

function approveUser(requestId) {
    if (!confirm('Are you sure you want to approve this user?')) return;

    const formData = new FormData();
    formData.append('action', 'approveUser');
    formData.append('requestId', requestId);

    fetch('adminhomepage.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('User approved successfully!', 'success');
            refreshAccountRequestsRecords(); // Refresh account requests
            refreshUserRecords(); // Refresh user records
        } else {
            showAlert('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error approving user', 'error');
    });
}

function rejectUser(requestId) {
    if (!confirm('Are you sure you want to reject this user?')) return;

    const formData = new FormData();
    formData.append('action', 'rejectUser');
    formData.append('requestId', requestId);

    fetch('adminhomepage.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('User rejected successfully!', 'success');
            refreshAccountRequestsRecords(); // Refresh account requests
        } else {
            showAlert('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error rejecting user', 'error');
    });
}

// Add function to refresh account requests
function refreshAccountRequestsRecords() {
    fetch('adminhomepage.php?action=getPendingUsers')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                globalPendingUsers = data.pendingUsers;
                updateAccountRequestsTable(data.pendingUsers);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error fetching account requests', 'error');
        });
}

// Add function to refresh user records
function refreshUserRecords() {
    fetch('adminhomepage.php?action=getApprovedUsers')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                globalUserRecords = data.approvedUsers;
                updateUserRecordsTable(data.approvedUsers);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error fetching user records', 'error');
        });
}

// Initialize tables when page loads
document.addEventListener('DOMContentLoaded', function() {
    refreshAccountRequestsRecords();
    refreshUserRecords();
});

// Copy-to-clipboard function
function copyToClipboard(text) {
    // Create a temporary textarea element
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    
    // Select and copy the text
    textarea.select();
    try {
        document.execCommand('copy');
        showAlert('Text copied to clipboard!', 'success');
    } catch (err) {
        console.error('Failed to copy text:', err);
        showAlert('Failed to copy text', 'danger');
    }
    
    // Remove the temporary textarea
    document.body.removeChild(textarea);
}
</script>
<script src="components.js"></script>
<script src="signup.js"></script>
</body>
</html>